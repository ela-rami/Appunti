<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appunti Lezione 2: Correttezza e Complessità Insertion Sort</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep-space: #111827;
            --bg-card: #1f2937;
            --bg-header: #1A202C;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --accent-primary: #60a5fa;
            --accent-secondary: #818cf8; /* Usato per i titoli delle sotto-sezioni della dimostrazione */
            --code-bg: #2a303c;
            --code-text: #c3c9d6;
            --border-soft: rgba(107, 114, 128, 0.2);
            --shadow-soft: rgba(0, 0, 0, 0.25);
            --font-main: 'Nunito Sans', sans-serif;
            --font-code: 'Source Code Pro', monospace;
            --sidebar-width: 280px;
            --header-height: 70px;
            --border-radius-main: 12px;
            --border-radius-small: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.7;
            color: var(--text-primary);
            background-color: var(--bg-deep-space);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: margin-left 0.3s ease-in-out;
        }

        header {
            background-color: var(--bg-header);
            color: var(--text-primary);
            padding: 0 2rem;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px var(--shadow-soft);
            border-bottom: 1px solid var(--border-soft);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            color: var(--accent-primary);
        }

        .hamburger-menu {
            display: block;
            font-size: 2rem;
            color: var(--accent-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
        }
        .hamburger-menu:hover {
            color: var(--text-primary);
        }

        #sidebar {
            background-color: var(--bg-card);
            color: var(--text-primary);
            padding: 1.5rem 1rem;
            width: var(--sidebar-width);
            position: fixed;
            top: var(--header-height);
            left: 0;
            height: calc(100% - var(--header-height));
            overflow-y: auto;
            box-shadow: 2px 0 10px var(--shadow-soft);
            border-right: 1px solid var(--border-soft);
            z-index: 900;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }

        #sidebar.hidden {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        #sidebar h2 {
            font-size: 1.25rem;
            margin-bottom: 1.2rem;
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 0.6rem;
            color: var(--accent-secondary);
            font-weight: 600;
        }

        #sidebar ul {
            list-style: none;
        }

        #sidebar ul li a {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.65rem 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease, padding-left 0.2s ease;
            border-radius: var(--border-radius-small);
            font-size: 0.9rem;
        }

        #sidebar ul li a:hover, #sidebar ul li a.active-link {
            background-color: rgba(96, 165, 250, 0.1);
            color: var(--accent-primary);
            padding-left: 1rem;
        }

        main {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2.5rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        body.sidebar-hidden main {
            margin-left: 0;
        }

        article {
            margin-bottom: 3rem;
            padding: 2rem;
            background-color: var(--bg-card);
            border-left: 4px solid var(--accent-primary);
            border-radius: var(--border-radius-main);
            box-shadow: 0 5px 15px var(--shadow-soft);
            display: none; 
        }
        article.active-section {
            display: block; 
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--accent-primary);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .subsection-title {
            font-size: 1.3rem;
            color: var(--accent-secondary);
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
            padding-bottom: 0.3rem;
            border-bottom: 1px dashed var(--border-soft);
        }


        .section-content {
            padding-left: 15px;
            border-left: 1px solid var(--border-soft);
            font-size: 0.95rem;
        }

        p, .math-notation {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }
        .math-notation {
            font-family: var(--font-code); /* Per una migliore resa delle formule testuali */
            background-color: rgba(42, 48, 60, 0.5);
            padding: 0.5rem;
            border-radius: var(--border-radius-small);
            display: block; /* Per occupare tutta la larghezza e avere padding */
            white-space: pre-wrap; /* Per andare a capo correttamente */
        }

        ul, ol {
            margin-left: 25px;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        li {
            margin-bottom: 0.5rem;
        }

        strong {
            font-weight: 700;
            color: var(--text-primary);
        }

        code, pre {
            font-family: var(--font-code);
        }

        code {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 0.2em 0.4em;
            border-radius: var(--border-radius-small);
            font-size: 0.85em;
        }

        pre {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 1.2rem;
            border-radius: var(--border-radius-small);
            overflow-x: auto;
            margin-bottom: 1.5rem;
            font-size: 0.9em;
            line-height: 1.6;
            border: 1px solid var(--border-soft);
        }

        pre code {
            background-color: transparent;
            padding: 0;
            font-size: inherit;
            color: inherit;
        }

        table.complexity-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            font-size: 0.9em;
        }
        .complexity-table th, .complexity-table td {
            border: 1px solid var(--border-soft);
            padding: 0.75rem;
            text-align: left;
            color: var(--text-secondary);
        }
        .complexity-table th {
            background-color: var(--code-bg);
            color: var(--text-primary);
            font-weight: 600;
        }
        .complexity-table tr:nth-child(even) {
            background-color: rgba(42, 48, 60, 0.3);
        }


        footer {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--bg-header);
            color: var(--text-secondary);
            margin-top: auto;
            border-top: 1px solid var(--border-soft);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 950;
        }
        body.sidebar-overlay-active .overlay {
            display: block;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-deep-space);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--accent-secondary);
            border-radius: 10px;
            border: 2px solid var(--bg-deep-space);
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-primary);
        }

        @media (max-width: 992px) {
            .hamburger-menu { display: block; }
            #sidebar {
                transform: translateX(calc(-1 * var(--sidebar-width)));
                top: 0; 
                height: 100vh;
                padding-top: 1.5rem;
                z-index: 1100;
                border-right: none;
            }
            #sidebar.open { transform: translateX(0); }
            main { margin-left: 0 !important; }
        }

        @media (min-width: 993px) {
            body:not(.sidebar-hidden) main { margin-left: var(--sidebar-width); }
            body.sidebar-hidden main { margin-left: 0; }
            #sidebar { transform: translateX(0); }
            #sidebar.hidden { transform: translateX(calc(-1 * var(--sidebar-width))); }
            .overlay { display: none !important; }
        }

        @media (max-width: 768px) {
            header h1 { font-size: 1.3rem; }
            main { padding: 2rem 1rem; }
            .section-title { font-size: 1.35rem; }
            article { padding: 1.5rem; }
            .complexity-table { font-size: 0.8em; }
            .complexity-table th, .complexity-table td { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="overlay"></div>
    <header>
        <button class="hamburger-menu" id="hamburger-btn">☰</button>
        <h1>Appunti Lezione 2: Correttezza e Complessità Insertion Sort</h1>
        <div></div>
    </header>

    <nav id="sidebar">
        <h2>Indice Argomenti</h2>
        <ul>
            <li><a href="#correttezza-insertion-sort" class="sidebar-link">1. Correttezza Insertion Sort</a></li>
            <li><a href="#complessita-insertion-sort" class="sidebar-link">2. Complessità Insertion Sort</a></li>
        </ul>
    </nav>

    <main>
        <article id="correttezza-insertion-sort" class="content-section">
            <h2 class="section-title">1. Correttezza dell'Algoritmo Insertion Sort</h2>
            <div class="section-content">
                <p>Per dimostrare che un algoritmo è corretto, dobbiamo provare due aspetti principali:</p>
                <ol>
                    <li><strong>Terminazione:</strong> L'algoritmo deve sempre finire dopo un numero finito di passi per qualsiasi input valido.</li>
                    <li><strong>Correttezza Parziale:</strong> Se l'algoritmo termina, deve produrre l'output corretto specificato dal problema.</li>
                </ol>

                <h3 class="subsection-title">Teorema di Correttezza per Insertion Sort</h3>
                <p>L'algoritmo <code>InsertionSort(A)</code> termina sempre e, al termine, l'array di input <code>A</code> è ordinato in modo non decrescente (cioè <code>A[1] ≤ A[2] ≤ ... ≤ A[A.length]</code>).</p>
                
                <h3 class="subsection-title">Dimostrazione tramite Invariante di Ciclo</h3>
                <p>Utilizzeremo un <strong>invariante di ciclo</strong> per il ciclo <code>for</code> esterno (quello indicizzato da `j`). Un invariante di ciclo è una proprietà che è vera:</p>
                <ul>
                    <li>Prima della prima iterazione del ciclo (Inizializzazione).</li>
                    <li>Se è vera prima di un'iterazione, rimane vera prima dell'iterazione successiva (Mantenimento).</li>
                    <li>Quando il ciclo termina, l'invariante fornisce una proprietà utile per dimostrare la correttezza (Terminazione/Conclusione).</li>
                </ul>

                <p><strong>Invariante del ciclo `for` esterno (per `j`):</strong></p>
                <p class="math-notation">"All'inizio della <em>j</em>-esima iterazione del ciclo <code>for</code> (cioè quando l'indice del ciclo <code>for</code> ha valore <code>j</code>), il sotto-array <code>A[1..j-1]</code> contiene gli elementi originariamente presenti in <code>A[1..j-1]</code>, ma in ordine non decrescente."</p>

                <h4 style="color: var(--accent-secondary); margin-top:1.5em; margin-bottom:0.5em;">Dimostrazione per Induzione su `j`:</h4>
                <p><strong>Caso Base (Inizializzazione): `j = 2`</strong></p>
                <ul>
                    <li><strong>Tesi:</strong> All'inizio della seconda iterazione (quando `j=2`), il sotto-array `A[1..2-1]`, cioè `A[1..1]` (che contiene solo `A[1]`), è ordinato.</li>
                    <li><strong>Dimostrazione:</strong> Un sotto-array contenente un solo elemento è sempre, per definizione, ordinato. Quindi, l'invariante è vero per `j=2`.</li>
                </ul>

                <p><strong>Passo Induttivo:</strong></p>
                <ul>
                    <li><strong>Ipotesi Induttiva (Hp.Ind.):</strong> Supponiamo che l'invariante sia vero all'inizio dell'iterazione <em>j</em>-esima, ovvero il sotto-array `A[1..j-1]` è ordinato.</li>
                    <li><strong>Tesi da dimostrare:</strong> Dobbiamo dimostrare che l'invariante sarà vero anche all'inizio dell'iterazione successiva, la <em>(j+1)</em>-esima. Questo significa che, dopo aver completato l'iterazione <em>j</em>-esima, il sotto-array `A[1..j]` risulterà ordinato.</li>
                    <li><strong>Dimostrazione del Passo Induttivo:</strong>
                        <ol>
                            <li>All'inizio dell'iterazione <em>j</em>-esima, <code>key ← A[j]</code>.</li>
                            <li>Il ciclo <code>while</code> interno (con indice `i` che parte da `j-1`) confronta <code>key</code> con gli elementi a sinistra in <code>A[1..j-1]</code>.</li>
                            <li>Tutti gli elementi in <code>A[1..j-1]</code> che sono maggiori di <code>key</code> vengono spostati di una posizione a destra.</li>
                            <li>Al termine del ciclo <code>while</code>, `i` indica la posizione a sinistra di dove <code>key</code> deve essere inserita (o è -1 se <code>key</code> è il minimo). L'istruzione <code>A[i+1] ← key</code> inserisce <code>key</code>.</li>
                            <li>Poiché <code>A[1..i]</code> era ordinato e <code>A[i] ≤ key</code> (o `i=0`), e <code>key</code> è minore o uguale agli elementi spostati (che erano in `A[i+1..j-1]`), il sotto-array <code>A[1..j]</code> è ora ordinato e contiene gli stessi elementi originali di `A[1..j]`.</li>
                            <li>Questo mantiene l'invariante per l'inizio dell'iterazione <em>(j+1)</em>-esima.</li>
                        </ol>
                    </li>
                </ul>

                <p><strong>Terminazione (Conclusione dell'Invariante):</strong></p>
                <ul>
                    <li>Il ciclo <code>for</code> esterno termina quando `j` diventa `A.length + 1`.</li>
                    <li>Secondo l'invariante, all'inizio di questa "pseudo-iterazione", il sotto-array `A[1..(A.length + 1) - 1]`, cioè `A[1..A.length]`, è ordinato.</li>
                    <li>Questo è esattamente ciò che il teorema di correttezza richiede.</li>
                </ul>

                <h3 class="subsection-title">Terminazione dell'Algoritmo Insertion Sort</h3>
                <ul>
                    <li>Il ciclo <code>while</code> interno termina perché l'indice `i` viene decrementato ad ogni sua iterazione e la condizione del ciclo include `i > 0`. Quindi `i` raggiungerà al massimo 0.</li>
                    <li>Il ciclo <code>for</code> esterno termina perché l'indice `j` viene incrementato da 2 fino a `A.length`. Quando `j` diventa `A.length + 1`, il ciclo si ferma.</li>
                </ul>
                <p>Poiché entrambi i cicli annidati terminano, l'intero algoritmo Insertion Sort termina.</p>
            </div>
        </article>

        <article id="complessita-insertion-sort" class="content-section">
            <h2 class="section-title">2. Analisi di Complessità dell'Algoritmo Insertion Sort</h2>
            <div class="section-content">
                <h3 class="subsection-title">Risorse Computazionali</h3>
                <p>Valutiamo gli algoritmi principalmente in base a due risorse:</p>
                <ul>
                    <li><strong>Spazio:</strong>
                        <ul>
                            <li><strong>In-place:</strong> Un algoritmo è in-place se modifica la struttura dati di input direttamente, usando solo una quantità di spazio di memoria aggiuntivo costante (indipendente dalla dimensione dell'input).</li>
                            <li><strong>Insertion Sort è in-place.</strong></li>
                        </ul>
                    </li>
                    <li><strong>Tempo:</strong> Il tempo di esecuzione.</li>
                </ul>

                <h3 class="subsection-title">Criterio di Costo Uniforme</h3>
                <p>Assumiamo che ogni operazione di base (elementare) abbia un costo costante, indicato genericamente con `c` (o `cᵢ` per l'istruzione i-esima). Le operazioni di base includono assegnamenti, confronti, operazioni aritmetiche semplici, accesso a elementi di array, incrementi/decrementi.</p>

                <h3 class="subsection-title">Analisi del Tempo di Esecuzione di Insertion Sort</h3>
                <p>Indichiamo con <code>n = A.length</code>. La funzione di costo <code>T(n)</code> è la somma dei costi di ogni istruzione moltiplicata per il numero di volte che viene eseguita.</p>
                
                <table class="complexity-table">
                    <thead>
                        <tr>
                            <th>Istruzione (Pseudo-codice)</th>
                            <th>Costo</th>
                            <th>Numero di Esecuzioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>for j ← 2 to n</code></td>
                            <td>c₁</td>
                            <td>n volte (testa n+1, ma entra n-1 volte + 1 uscita)</td>
                        </tr>
                        <tr>
                            <td><code>    key ← A[j]</code></td>
                            <td>c₂</td>
                            <td>n - 1 volte</td>
                        </tr>
                        <tr>
                            <td><code>    i ← j - 1</code></td>
                            <td>c₃</td>
                            <td>n - 1 volte</td>
                        </tr>
                        <tr>
                            <td><code>    while (i > 0 and A[i] > key) do</code></td>
                            <td>c₄</td>
                            <td>Σ<sub>j=2..n</sub> t<sub>j</sub></td>
                        </tr>
                        <tr>
                            <td><code>        A[i+1] ← A[i]</code></td>
                            <td>c₅</td>
                            <td>Σ<sub>j=2..n</sub> (t<sub>j</sub> - 1)</td>
                        </tr>
                        <tr>
                            <td><code>        i ← i - 1</code></td>
                            <td>c₆</td>
                            <td>Σ<sub>j=2..n</sub> (t<sub>j</sub> - 1)</td>
                        </tr>
                        <tr>
                            <td><code>    A[i+1] ← key</code></td>
                            <td>c₇</td>
                            <td>n - 1 volte</td>
                        </tr>
                    </tbody>
                </table>
                <p>Dove <strong>t<sub>j</sub></strong> è il numero di volte che il test della condizione del ciclo <code>while</code> viene eseguito per un dato valore di `j`.</p>

                <h4 style="color: var(--accent-secondary); margin-top:1.5em; margin-bottom:0.5em;">Caso Ottimo (Best Case)</h4>
                <p>L'array è già ordinato. La condizione <code>A[i] > key</code> del <code>while</code> è sempre falsa al primo controllo. Quindi, <strong>t<sub>j</sub> = 1</strong> per ogni `j`.</p>
                <p class="math-notation">T<sub>ottimo</sub>(n) = c₁n + c₂(n-1) + c₃(n-1) + c₄(n-1) + c₅(0) + c₆(0) + c₇(n-1)<br>
                T<sub>ottimo</sub>(n) = (c₁ + c₂ + c₃ + c₄ + c₇)n - (c₂ + c₃ + c₄ + c₇)<br>
                Questa è una funzione lineare del tipo <code>an + b</code>. Asintoticamente: <strong>Θ(n)</strong>.</p>

                <h4 style="color: var(--accent-secondary); margin-top:1.5em; margin-bottom:0.5em;">Caso Pessimo (Worst Case)</h4>
                <p>L'array è ordinato in ordine inverso. La <code>key</code> è sempre più piccola di tutti gli elementi precedenti. Il ciclo <code>while</code> scorre tutti gli elementi fino all'inizio. Quindi, <strong>t<sub>j</sub> = j</strong>.</p>
                <p>Dobbiamo calcolare le sommatorie:</p>
                <p class="math-notation">Σ<sub>j=2..n</sub> t<sub>j</sub> = Σ<sub>j=2..n</sub> j = (Σ<sub>j=1..n</sub> j) - 1 = (n(n+1)/2) - 1</p>
                <p class="math-notation">Σ<sub>j=2..n</sub> (t<sub>j</sub> - 1) = Σ<sub>j=2..n</sub> (j-1) = Σ<sub>k=1..n-1</sub> k = (n-1)n/2</p>
                <p>Sostituendo nella formula generale di T(n), i termini dominanti saranno quelli con n².</p>
                <p class="math-notation">T<sub>pessimo</sub>(n) è una funzione quadratica del tipo <code>an² + bn + c</code>. Asintoticamente: <strong>Θ(n²)</strong>.</p>

                <h4 style="color: var(--accent-secondary); margin-top:1.5em; margin-bottom:0.5em;">Caso Medio (Average Case)</h4>
                <p>Assumendo una distribuzione uniforme degli input (ogni permutazione è equiprobabile), in media la <code>key</code> viene spostata circa a metà della porzione ordinata. Quindi, <strong>t<sub>j</sub> ≈ j/2</strong>.</p>
                <p>Anche in questo caso, la complessità risultante è quadratica. Asintoticamente: <strong>Θ(n²)</strong>.</p>
                
                <h3 class="subsection-title">Conclusione sull'Analisi di Insertion Sort</h3>
                <ul>
                    <li><strong>Spazio:</strong> Θ(1) (in-place).</li>
                    <li><strong>Tempo:</strong>
                        <ul>
                            <li>Caso Ottimo: Θ(n)</li>
                            <li>Caso Pessimo: Θ(n²)</li>
                            <li>Caso Medio: Θ(n²)</li>
                        </ul>
                    </li>
                </ul>
                <p>Insertion Sort è efficiente per input piccoli o quasi ordinati, ma la sua complessità quadratica lo rende meno adatto per grandi set di dati disordinati.</p>
            </div>
        </article>
    </main>

    <footer>
        <p>© 2023 Appunti Corso Algoritmi</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const allContentSections = document.querySelectorAll('.content-section');
            const headerElement = document.querySelector('header');
            let headerHeight = headerElement ? headerElement.offsetHeight : 70;

            const sidebar = document.getElementById('sidebar');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const overlay = document.querySelector('.overlay');
            const body = document.body;
            const sidebarLinks = document.querySelectorAll('#sidebar a.sidebar-link');


            function adjustLayoutForSidebar() {
                if (headerElement) { headerHeight = headerElement.offsetHeight; }
                if (window.innerWidth > 992) {
                    sidebar.style.top = headerHeight + 'px';
                    sidebar.style.height = `calc(100% - ${headerHeight}px)`;
                    if (sidebar.classList.contains('hidden-desktop-explicit')) {
                        body.classList.add('sidebar-hidden');
                    } else {
                        body.classList.remove('sidebar-hidden');
                        sidebar.classList.remove('hidden');
                    }
                    body.classList.remove('sidebar-overlay-active');
                    if(overlay) overlay.style.display = 'none';
                } else {
                    sidebar.style.top = '0';
                    sidebar.style.height = '100vh';
                    body.classList.add('sidebar-hidden'); 
                    if (sidebar.classList.contains('open')) {
                        body.classList.add('sidebar-overlay-active');
                        if(overlay) overlay.style.display = 'block';
                    } else {
                        sidebar.classList.add('hidden'); 
                        body.classList.remove('sidebar-overlay-active');
                        if(overlay) overlay.style.display = 'none';
                    }
                }
            }
            
            window.addEventListener('resize', adjustLayoutForSidebar);

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', () => {
                    const sidebarIsCurrentlyHiddenOrNotOpen = sidebar.classList.contains('hidden') || !sidebar.classList.contains('open');
                    
                    sidebar.classList.toggle('hidden', !sidebarIsCurrentlyHiddenOrNotOpen);
                    sidebar.classList.toggle('open', sidebarIsCurrentlyHiddenOrNotOpen);

                    if (window.innerWidth > 992) {
                        body.classList.toggle('sidebar-hidden', !sidebarIsCurrentlyHiddenOrNotOpen);
                        if (sidebar.classList.contains('hidden')) {
                            sidebar.classList.add('hidden-desktop-explicit');
                        } else {
                            sidebar.classList.remove('hidden-desktop-explicit');
                        }
                    } else {
                         body.classList.toggle('sidebar-overlay-active', sidebarIsCurrentlyHiddenOrNotOpen);
                         if(overlay) overlay.style.display = sidebarIsCurrentlyHiddenOrNotOpen ? 'block' : 'none';
                    }
                });
            }

            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('open');
                    body.classList.remove('sidebar-overlay-active');
                    if(overlay) overlay.style.display = 'none';
                     if (window.innerWidth > 992) {
                        body.classList.add('sidebar-hidden');
                        sidebar.classList.add('hidden-desktop-explicit');
                    }
                });
            }

            function showSection(targetId, smoothScroll = true) {
                allContentSections.forEach(s => {
                    s.classList.remove('active-section');
                    s.style.display = 'none';
                });
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active-section');
                    targetSection.style.display = 'block';

                    if (smoothScroll) {
                        const targetPosition = targetSection.offsetTop - headerHeight - 20;
                        window.scrollTo({
                            top: targetPosition,
                            behavior: "smooth"
                        });
                    }
                }
            }
            
            sidebarLinks.forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    
                    sidebarLinks.forEach(link => link.classList.remove('active-link'));
                    this.classList.add('active-link');

                    showSection(targetId);
                    history.pushState(null, null, `#${targetId}`);

                    if (window.innerWidth <= 992) {
                        sidebar.classList.add('hidden');
                        sidebar.classList.remove('open');
                        body.classList.remove('sidebar-overlay-active');
                        if(overlay) overlay.style.display = 'none';
                    }
                });
            });
            
            function setActiveSidebarLinkOnScroll() {
                let currentSectionId = "";
                const visibleSections = Array.from(allContentSections).filter(s => s.style.display === 'block');
                
                if (visibleSections.length === 1) {
                    currentSectionId = visibleSections[0].id;
                } else { 
                    for (let i = allContentSections.length - 1; i >= 0; i--) {
                        const section = allContentSections[i];
                        const sectionTop = section.offsetTop - headerHeight - (window.innerHeight * 0.3);
                        if (window.pageYOffset >= sectionTop) {
                            currentSectionId = section.id;
                            break; 
                        }
                    }
                }
                
                if (!currentSectionId && window.location.hash) {
                    currentSectionId = window.location.hash.substring(1);
                } else if (!currentSectionId && allContentSections.length > 0) {
                     const firstActive = document.querySelector('.content-section.active-section');
                     if (firstActive) {
                         currentSectionId = firstActive.id;
                     } else if (document.querySelector('#sidebar a.sidebar-link')) {
                        currentSectionId = document.querySelector('#sidebar a.sidebar-link').getAttribute('href').substring(1);
                     }
                }

                sidebarLinks.forEach(link => {
                    link.classList.remove('active-link');
                    if (link.getAttribute('href') === `#${currentSectionId}`) {
                        link.classList.add('active-link');
                    }
                });
            }
            window.addEventListener('scroll', setActiveSidebarLinkOnScroll);

            if (window.location.hash) {
                const targetId = window.location.hash.substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement && Array.from(allContentSections).includes(targetElement)) {
                     showSection(targetId, false);
                     setTimeout(() => {
                        const targetPosition = targetElement.offsetTop - headerHeight - 20;
                        window.scrollTo({ top: targetPosition, behavior: "auto" });
                        document.querySelector(`#sidebar a[href="${window.location.hash}"]`)?.classList.add('active-link');
                    }, 0);
                } else if (allContentSections.length > 0) {
                    const firstSectionId = allContentSections[0].id;
                    showSection(firstSectionId);
                    document.querySelector(`#sidebar a[href="#${firstSectionId}"]`)?.classList.add('active-link');
                }
            } else if (allContentSections.length > 0) {
                const firstSectionId = allContentSections[0].id;
                showSection(firstSectionId);
                document.querySelector(`#sidebar a[href="#${firstSectionId}"]`)?.classList.add('active-link');
            }
            
            adjustLayoutForSidebar();
            if (window.innerWidth > 992) {
                 if (localStorage.getItem('sidebarState') === 'hidden') {
                    sidebar.classList.add('hidden', 'hidden-desktop-explicit');
                    body.classList.add('sidebar-hidden');
                } else { 
                    sidebar.classList.remove('hidden', 'hidden-desktop-explicit');
                    body.classList.remove('sidebar-hidden');
                }
            } else {
                 sidebar.classList.add('hidden');
            }
        });
    </script>
</body>
</html>